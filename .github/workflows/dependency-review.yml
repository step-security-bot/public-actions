name: Coveo Dependency Reviewer

on:
  workflow_call:
    inputs:
      public:
        required: true
        type: boolean
        default: false
      distributed:
        required: true
        type: boolean
        default: true
      comment-summary-in-pr:
        description: Determines if the summary is posted as a comment in the PR itself. Setting this to `always` or `on-failure` requires you to give the workflow the write permissions for pull-requests
        required: false
        default: on-failure
        type: string

jobs:
  dependency-review:
    name: Dependency Review

    runs-on: ubuntu-latest

    permissions:
      pull-requests: write

    steps:
      - name: Checkout scan target
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Checkout licenses
        uses:  actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          repository: coveo/dependency-allowed-licenses
          path: coveo-dependency-allowed-licenses

      - name: Select configuration
        id: select-config
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          INPUTS: ${{ toJSON(inputs) }}
        with:
          result-encoding: string
          script: |
            const inputs = JSON.parse(process.env.INPUTS)
            if (inputs.public) {
              return 'public.yml'
            }
            if (!inputs.public && inputs.distributed) {
              return 'private-distributed.yml'
            }
            if (!inputs.public && !inputs.distributed) {
              return 'private-undistributed.yml'
            }

            core.setFailure(`Could not determine configuration for inputs: ${inputs}`)

      - name: Scan
        uses: actions/dependency-review-action@9129d7d40b8c12c1ed0f60400d00c92d437adcce # v4.1.3
        with:
          comment-summary-in-pr: ${{ inputs.comment-summary-in-pr }}
          fail-on-severity: high
          config-file: ./coveo-dependency-allowed-licenses/${{ steps.select-config.outputs.result }}
